{% extends "base.html" %}
{% block title %}IP Blacklist - Firewall Monitor{% endblock %}

{% block style %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/blacklist.css') }}">
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/blacklist.js') }}"></script>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2><i class="fas fa-network-wired"></i> IP/Domain Management</h2>
    <div class="btn-group">
        <button class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#addBlacklistModal">
            <i class="fas fa-plus"></i> Add IP to Firewall
        </button>
        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#addDomainModal">
            <i class="fas fa-globe"></i> Add Domain to Firewall
        </button>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4">
        <div class="card bg-danger text-white">
            <div class="card-body text-center">
                <i class="fas fa-ban fa-2x mb-2"></i>
                <h5>Total Blacklisted</h5>
                <h2>{{ blacklist_entries|length }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-clock fa-2x mb-2"></i>
                <h5>Added Today</h5>
                <h2>{{ blacklist_entries|selectattr('2', 'match', '.*' + today + '.*')|list|length if today is defined
                    else 0 }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-shield-alt fa-2x mb-2"></i>
                <h5>Protection Level</h5>
                <h2>HIGH</h2>
            </div>
        </div>
    </div>
</div>

<!-- Search and Filter Controls -->
<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="searchInput" placeholder="Search IP addresses...">
        </div>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="entriesPerPage">
            <option value="10" selected>10 entries</option>
            <option value="25">25 entries</option>
            <option value="50">50 entries</option>
            <option value="100">100 entries</option>
        </select>
    </div>
    <div class="col-md-3">
        <select class="form-select" id="statusFilter">
            <option value="all">All Status</option>
            <option value="active">Active Only</option>
            <option value="inactive">Inactive Only</option>
        </select>
    </div>
</div>

<div class="card">
    <div class="card-header">
        <h5><i class="fas fa-list"></i> Blacklisted IP Addresses</h5>
    </div>
    <div class="card-body p-0">
        {% if blacklist_entries %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="blacklistTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="ip">
                            <i class="fas fa-network-wired"></i> IP Address
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="reason">
                            <i class="fas fa-comment"></i> Reason
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="date">
                            <i class="fas fa-calendar"></i> Added Date
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="status">
                            <i class="fas fa-toggle-on"></i> Status
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% for ip_address, reason, added_date, is_active in blacklist_entries %}
                    <tr class="{% if not is_active %}table-secondary{% endif %}" data-ip="{{ ip_address }}"
                        data-reason="{{ reason }}" data-date="{{ added_date }}"
                        data-status="{{ 'active' if is_active else 'inactive' }}">
                        <td>
                            <code class="{% if is_active %}text-danger{% else %}text-muted{% endif %}">
                                {{ ip_address }}
                            </code>
                        </td>
                        <td>
                            <span class="badge bg-secondary">{{ reason }}</span>
                        </td>
                        <td>
                            <small>{{ added_date }}</small>
                        </td>
                        <td>
                            {% if is_active %}
                            <span class="badge bg-danger">
                                <i class="fas fa-ban"></i> Active
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-pause"></i> Inactive
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if is_active %}
                            <a href="#" class="btn btn-sm btn-outline-success unblock-btn"
                                onclick="unBlockIP('{{ ip_address }}')">
                                <i class="fas fa-check"></i> Unblock
                            </a>
                            {% else %}
                            <a href="#" class="btn btn-sm btn-outline-danger"
                                onclick="blockIP('{{ ip_address }}', ' Blacklist Entry')">
                                <i class="fas fa-ban"></i> Block
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3">
            <div class="text-muted">
                Showing <span id="showingStart">1</span> to <span id="showingEnd">10</span> of <span
                    id="totalEntries">{{ blacklist_entries|length }}</span> entries
            </div>
            <nav aria-label="Table pagination">
                <ul class="pagination pagination-sm mb-0" id="pagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-shield-alt fa-4x text-success mb-3"></i>
            <h4>No IP addresses in blacklist</h4>
            <p class="text-muted">Your system is currently not blocking any IP addresses.</p>
        </div>
        {% endif %}
    </div>
</div>

<div class="card mt-4">
    <div class="card-header">
        <h5><i class="fas fa-globe"></i> Blacklisted Domains</h5>
    </div>
    <div class="card-body p-0">
        {% if domain_blacklist_entries %}
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="domainBlacklistTable">
                <thead>
                    <tr>
                        <th class="sortable" data-column="domain">
                            <i class="fas fa-globe"></i> Domain
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="reason">
                            <i class="fas fa-comment"></i> Reason
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="date">
                            <i class="fas fa-calendar"></i> Added Date
                            <i class="fas fa-sort sort-icon"></i>
                        </th>
                        <th class="sortable" data-column="status">
                            <i class="fas fa-toggle-on"></i> Status
                            <i class="fas fa-sort sort-icon"></i>
                        <th><i class="fas fa-cogs"></i> Actions</th>
                    </tr>
                </thead>
                <tbody id="domainTableBody">
                    {% for domain, reason, added_date, is_active in domain_blacklist_entries %}
                    <tr class="{% if not is_active %}table-secondary{% endif %}" data-domain="{{ domain }}"
                        data-reason="{{ reason }}" data-date="{{ added_date }}">
                        <td>{{ domain }}</td>
                        <td>{{ reason }}</td>
                        <td>{{ added_date }}</td>
                        <td>
                            {% if is_active %}
                            <span class="badge bg-danger">
                                <i class="fas fa-ban"></i> Active
                            </span>
                            {% else %}
                            <span class="badge bg-secondary">
                                <i class="fas fa-pause"></i> Inactive
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            {% if is_active %}
                            <a href="#" class="btn btn-sm btn-outline-success unblock-domain-btn"
                                onclick="unBlockDomain('{{ domain }}')">
                                <i class="fas fa-check"></i> Unblock
                            </a>
                            {% else %}
                            <a href="#" class="btn btn-sm btn-outline-danger"
                                onclick="blockDomain('{{ domain }}', ' Domain Blacklist Entry')">
                                <i class="fas fa-ban"></i> Block
                            </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <!-- Pagination Controls -->
        <div class="d-flex justify-content-between align-items-center mt-3 px-3 pb-3">
            <div class="text-muted">
                Showing <span id="domainShowingStart">1</span> to <span id="domainShowingEnd">10</span> of <span
                    id="domainTotalEntries">{{ domain_blacklist_entries|length }}</span> entries
            </div>
            <nav aria-label="Domain pagination">
                <ul class="pagination pagination-sm mb-0" id="domainPagination">
                    <!-- Pagination buttons will be generated by JavaScript -->
                </ul>
            </nav>
        </div>
        {% else %}
        <div class="text-center py-5">
            <i class="fas fa-globe fa-4x text-warning mb-3"></i>
            <h4>No domains in blacklist</h4>
            <p class="text-muted">Your system is currently not blocking any domains.</p>
        </div>
        {% endif %}
    </div>
</div>



<!-- Add Blacklist Modal -->
<div class="modal fade" id="addBlacklistModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-ban"></i> Add to Blacklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">
                <!-- Toggle buttons -->
                <div class="mb-3 text-center" style="display: none;">
                    <div class="btn-group" role="group">
                        <input type="radio" class="btn-check" name="inputType" id="singleIpOption" autocomplete="off"
                            checked onclick="toggleInputType('single')">
                        <label class="btn btn-outline-primary" for="singleIpOption">Single IP/IP Range</label>
                    </div>
                </div>

                <!-- Form Inputs -->
                <form id="blacklistForm" onsubmit="return false;">
                    <!-- Single IP -->
                    <div id="singleIpInput" class="mb-3">
                        <label for="ip">IP Address *</label>
                        <input type="text" class="form-control" id="ip" name="ip" required
                            placeholder="Single IP/IP Range: e.g., 192.168.1.100 or 2001:db8::1 or ip1-ip2"
                            pattern="^(?:(?:[0-9]{1,3}\.){3}[0-9]{1,3}|(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:)*::(?:[0-9a-fA-F]{1,4}:)*[0-9a-fA-F]{1,4})$">
                    </div>

                    <!-- IP Range -->
                    <div id="rangeIpInput" style="display:none">
                        <div class="mb-3">
                            <label>Start IP *</label>
                            <input type="text" class="form-control" id="start_ip" required
                                placeholder="e.g., 192.168.1.100 or 2001:db8::1"
                                pattern="^(?:(?:[0-9]{1,3}\.){3}[0-9]{1,3}|(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:)*::(?:[0-9a-fA-F]{1,4}:)*[0-9a-fA-F]{1,4})$">
                        </div>
                        <div class="mb-3">
                            <label>End IP *</label>
                            <input type="text" class="form-control" id="end_ip" required
                                placeholder="e.g., 192.168.1.200 or 2001:db8::1"
                                pattern="^(?:(?:[0-9]{1,3}\.){3}[0-9]{1,3}|(?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:)*::(?:[0-9a-fA-F]{1,4}:)*[0-9a-fA-F]{1,4})$">
                        </div>
                    </div>

                    <!-- Port Selection -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <input type="checkbox" class="form-check-input me-2" id="enablePorts"
                                onchange="togglePortSelection()">
                            <label for="enablePorts" class="form-check-label">Include specific ports</label>
                        </div>

                        <div id="portSelection" style="display: none;">
                            <!-- Multiple Ports -->
                            <input type="text" class="form-control" id="multiplePorts"
                                placeholder="e.g., 80,443,5000-5050">
                            <small class="form-text text-muted">Separate ports with commas</small>
                            <div id="multiplePortsInput" style="display: none;" class="col-12">
                                <div class="d-flex flex-wrap justify-content-between">
                                    <!-- Local ports -->
                                    <div id="local_ports" class="col-5 mb-3">
                                        <label for="multiplePortsLocal" class="form-label"><strong>Local
                                                Ports:</strong></label>
                                        <input type="text" class="form-control" id="multiplePortsLocal"
                                            placeholder="e.g., 8080,8443,6000-6050">
                                    </div>
                                    <!-- Remote ports -->
                                    <div id="remote_ports" class="col-5 mb-3">
                                        <label for="multiplePorts" class="form-label"> <strong>Remote
                                                Ports:</strong></label>
                                        <input type="text" class="form-control" id="multiplePorts"
                                            placeholder="e.g., 80,443,5000-5050">
                                    </div>
                                </div>

                            </div>



                        </div>
                    </div>

                    <!-- Protocol Selection -->
                    <div class="mb-3">
                        <div class="d-flex align-items-center mb-2">
                            <input type="checkbox" class="form-check-input me-2" id="enableProtocol"
                                onchange="toggleProtocolSelection()">
                            <label for="enableProtocol" class="form-check-label">Include specific protocols</label>
                        </div>

                        <div id="protocolSelection" style="display: none;">


                            <!-- Multiple Protocols -->
                            <div id="multipleProtocolsInput">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="border p-2 rounded" style="max-height: 150px; overflow-y: auto;">
                                            <div class="row">
                                                <div class="col-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="tcp"
                                                            id="protocol_tcp">
                                                        <label class="form-check-label" for="protocol_tcp">TCP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="udp"
                                                            id="protocol_udp">
                                                        <label class="form-check-label" for="protocol_udp">UDP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="icmp"
                                                            id="protocol_icmp">
                                                        <label class="form-check-label" for="protocol_icmp">ICMP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="http"
                                                            id="protocol_http">
                                                        <label class="form-check-label" for="protocol_http">HTTP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="https"
                                                            id="protocol_https">
                                                        <label class="form-check-label"
                                                            for="protocol_https">HTTPS</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="ftp"
                                                            id="protocol_ftp">
                                                        <label class="form-check-label" for="protocol_ftp">FTP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="ssh"
                                                            id="protocol_ssh">
                                                        <label class="form-check-label" for="protocol_ssh">SSH</label>
                                                    </div>
                                                </div>
                                                <div class="col-6">
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="telnet"
                                                            id="protocol_telnet">
                                                        <label class="form-check-label"
                                                            for="protocol_telnet">Telnet</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="smtp"
                                                            id="protocol_smtp">
                                                        <label class="form-check-label" for="protocol_smtp">SMTP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="pop3"
                                                            id="protocol_pop3">
                                                        <label class="form-check-label" for="protocol_pop3">POP3</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="imap"
                                                            id="protocol_imap">
                                                        <label class="form-check-label" for="protocol_imap">IMAP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="dns"
                                                            id="protocol_dns">
                                                        <label class="form-check-label" for="protocol_dns">DNS</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="dhcp"
                                                            id="protocol_dhcp">
                                                        <label class="form-check-label" for="protocol_dhcp">DHCP</label>
                                                    </div>
                                                    <div class="form-check">
                                                        <input class="form-check-input" type="checkbox" value="snmp"
                                                            id="protocol_snmp">
                                                        <label class="form-check-label" for="protocol_snmp">SNMP</label>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">Select one or more protocols</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Reason -->
                    <div class="mb-3">
                        <label for="reasonSelect">Reason</label>
                        <select class="form-select" id="reasonSelect" onchange="toggleCustomReason()">
                            <option value="Suspicious activity">Suspicious activity</option>
                            <option value="Rate limit exceeded">Rate limit exceeded</option>
                            <option value="Malicious requests">Malicious requests</option>
                            <option value="Spam/Bot activity">Spam/Bot activity</option>
                            <option value="Security threat">Security threat</option>
                            <option value="custom">Custom reason...</option>
                        </select>
                        <input type="text" class="form-control mt-2" id="customReason" style="display: none;"
                            placeholder="Enter custom reason">
                    </div>

                    <!-- Add to pending list -->
                    <div class="mb-3 text-end">
                        <button type="button" class="btn btn-success" onclick="addToPendingList()">
                            <i class="fas fa-plus"></i> Add to List
                        </button>
                    </div>
                </form>

                <!-- Bootstrap alert -->
                <div id="alertBox" class="alert alert-danger alert-dismissible fade d-none" role="alert">
                    <span id="alertMessage"></span>
                    <button type="button" class="btn-close" onclick="hideAlert()"></button>
                </div>

                <!-- Pending List -->
                <div>
                    <h6>Pending IPs:</h6>
                    <ul class="list-group" id="pendingList"></ul>
                </div>
            </div>

            <div class="modal-footer">
                <form method="POST" action="/submit_blacklist" id="submitForm">
                    <input type="hidden" name="entries" id="entriesData">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger" onclick="submitPendingList()">
                        <i class="fas fa-paper-plane"></i> Save Blacklist
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
<script>
    let pendingEntries = [];

    function valid_IP(ip) {
        const ipv4Regex = /^(25[0-5]|2[0-4][0-9]|1?[0-9]{1,2})(\.(25[0-5]|2[0-4][0-9]|1?[0-9]{1,2})){3}$/;
        const ipv6Regex = /^((?:[0-9a-fA-F]{1,4}:){7}[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,7}:|:(?::[0-9a-fA-F]{1,4}){1,7}|(?:[0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|(?:[0-9a-fA-F]{1,4}:){1,5}(?::[0-9a-fA-F]{1,4}){1,2}|(?:[0-9a-fA-F]{1,4}:){1,4}(?::[0-9a-fA-F]{1,4}){1,3}|(?:[0-9a-fA-F]{1,4}:){1,3}(?::[0-9a-fA-F]{1,4}){1,4}|(?:[0-9a-fA-F]{1,4}:){1,2}(?::[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:(?:(?::[0-9a-fA-F]{1,4}){1,6}))$/;
        return ipv4Regex.test(ip) || ipv6Regex.test(ip);
    }

    function ipToNumber(ip) {
        // Simple IPv4 to number conversion (for demonstration)
        const parts = ip.split('.');
        if (parts.length === 4) {
            return parseInt(parts[0]) * 16777216 + parseInt(parts[1]) * 65536 + parseInt(parts[2]) * 256 + parseInt(parts[3]);
        }
        return 0; // IPv6 handling would be more complex
    }

    function toggleInputType(type) {
        const singleDiv = document.getElementById('singleIpInput');
        const rangeDiv = document.getElementById('rangeIpInput');

        if (type === 'single') {
            singleDiv.style.display = 'block';
            rangeDiv.style.display = 'none';
            document.getElementById('singleIpOption').checked = true;
        } else {
            singleDiv.style.display = 'none';
            rangeDiv.style.display = 'block';
            document.getElementById('rangeIpOption').checked = true;
        }
    }

    function togglePortSelection() {
        const checkbox = document.getElementById('enablePorts');
        const portSelection = document.getElementById('portSelection');
        portSelection.style.display = checkbox.checked ? 'block' : 'none';
        const multipleInput = document.getElementById('multiplePortsInput');
        multipleInput.style.display = checkbox.checked ? 'block' : 'none';
    }

    function togglePortType(type) {
        const multipleInput = document.getElementById('multiplePortsInput');

        multipleInput.style.display = 'none';

        if (type === 'multiple') {
            multipleInput.style.display = 'block';
        }
    }

    function toggleProtocolSelection() {
        const checkbox = document.getElementById('enableProtocol');
        const protocolSelection = document.getElementById('protocolSelection');
        protocolSelection.style.display = checkbox.checked ? 'block' : 'none';
    }

    function toggleProtocolType(type) {
        const multipleInput = document.getElementById('multipleProtocolsInput');
        if (type === 'multiple') {
            multipleInput.style.display = 'block';
        }
    }

    function toggleCustomReason() {
        const select = document.getElementById('reasonSelect');
        const customInput = document.getElementById('customReason');
        customInput.style.display = select.value === 'custom' ? 'block' : 'none';
    }

    function validateProtocols() {
        const enableProtocol = document.getElementById('enableProtocol').checked;
        if (!enableProtocol) return { valid: true, protocols: null };
        const protocolCheckboxes = document.querySelectorAll('#multipleProtocolsInput input[type="checkbox"]:checked');
        if (protocolCheckboxes.length === 0) {
            return { valid: false, error: "At least one protocol must be selected." };
        }

        const selectedProtocols = Array.from(protocolCheckboxes).map(cb => cb.value);
        return { valid: true, protocols: selectedProtocols };

    }
    function validatePorts() {
        const enablePorts = document.getElementById('enablePorts').checked;
        if (!enablePorts) return { valid: true, ports: null };

        const ports = document.getElementById('multiplePorts').value.trim();
        if (!ports) {
            return { valid: false, error: "Multiple ports are required when port option is enabled." };
        }
        const portArray = ports.split(',').map(p => p.trim()).filter(p => p);
        if (portArray.length === 0) {
            return { valid: false, error: "At least one port is required." };
        }

        // Tách các khoảng port có dạng a-b ra khỏi các port đơn
        for (let port of portArray) {
            if (port.includes('-')) {
                const [start, end] = port.split('-').map(p => parseInt(p.trim()));
                if (isNaN(start) || isNaN(end) || start < 1 || end > 65535 || start > end) {
                    return { valid: false, error: `Invalid port range: ${port}. Ensure it is in the format a-b and within 1-65535.` };
                }
            } else {
                const portNum = parseInt(port);
                if (isNaN(portNum) || portNum < 1 || portNum > 65535) {
                    return { valid: false, error: `Invalid port: ${port}. Ports must be between 1 and 65535.` };
                }
            }
        }

        return { valid: true, ports: portArray };

    }



    function addToPendingList() {
        const type = document.getElementById('singleIpOption').checked ? 'single' : 'range';

        clearValidation();
        let entry = {};

        const ip_address = document.getElementById('ip').value.trim();
        // Kiểm tra xem ip_address đơn hay khoảng
        if (ip_address && ip_address.includes('-')) {
            const [start_ip, end_ip] = ip_address.split('-').map(ip => ip.trim());
            if (!valid_IP(start_ip)) {
                markInvalid('start_ip');
                showAlert("Invalid Start IP.");
                return;
            }
            if (!valid_IP(end_ip)) {
                markInvalid('end_ip');
                showAlert("Invalid End IP.");
                return;
            }
            if (ipToNumber(start_ip) > ipToNumber(end_ip)) {
                markInvalid('start_ip');
                markInvalid('end_ip');
                showAlert("Start IP must be less than or equal to End IP.");
                return;
            }
            entry = { type: 'range', start_ip, end_ip };
        } else {
            const ip = ip_address;
            if (!valid_IP(ip)) {
                markInvalid('ip');
                showAlert("Invalid IPv4/IPv6 address.");
                return;
            }

            if (isDuplicateSingle(ip)) {
                markInvalid('ip');
                showAlert("This IP already exists or overlaps with a range.");
                return;
            }

            entry = { type: 'single', ip };
        }

        // Validate ports
        const portValidation = validatePorts();
        if (!portValidation.valid) {
            showAlert(portValidation.error);
            return;
        }
        entry.ports = portValidation.ports;

        // Validate protocols
        const protocolValidation = validateProtocols();
        if (!protocolValidation.valid) {
            showAlert(protocolValidation.error);
            return;
        }
        entry.protocols = protocolValidation.protocols;

        // Reason
        const reason = document.getElementById('reasonSelect').value;
        entry.reason = (reason === 'custom')
            ? document.getElementById('customReason').value.trim()
            : reason;

        pendingEntries.push(entry);
        updatePendingList();
        hideAlert();
        document.getElementById('blacklistForm').reset();
        document.getElementById('enablePorts').checked = false;
        document.getElementById('enableProtocol').checked = false;
        togglePortSelection();
        toggleProtocolSelection();
        toggleInputType('single');
        clearValidation();
    }

    function isDuplicateSingle(newIp) {
        const newNum = ipToNumber(newIp);

        return pendingEntries.some(entry => {
            if (entry.type === 'single') {
                return entry.ip === newIp;
            } else {
                const start = ipToNumber(entry.start_ip);
                const end = ipToNumber(entry.end_ip);
                return newNum >= start && newNum <= end;
            }
        });
    }

    function isDuplicateRange(newStart, newEnd) {
        const newStartNum = ipToNumber(newStart);
        const newEndNum = ipToNumber(newEnd);

        return pendingEntries.some(entry => {
            if (entry.type === 'single') {
                const ipNum = ipToNumber(entry.ip);
                return ipNum >= newStartNum && ipNum <= newEndNum;
            } else {
                const start = ipToNumber(entry.start_ip);
                const end = ipToNumber(entry.end_ip);
                return !(newEndNum < start || newStartNum > end);
            }
        });
    }

    function formatPortsDisplay(ports) {
        if (!ports) return '';

        if (Array.isArray(ports)) {
            return ` [Ports: ${ports.join(', ')}]`;
        } else if (ports.start && ports.end) {
            return ` [Ports: ${ports.start}-${ports.end}]`;
        }
        return '';
    }

    function formatProtocolsDisplay(protocols) {
        if (!protocols || !Array.isArray(protocols) || protocols.length === 0) return '';
        return ` [Protocols: ${protocols.join(', ').toUpperCase()}]`;
    }

    function updatePendingList() {
        const list = document.getElementById('pendingList');
        list.innerHTML = "";
        pendingEntries.forEach((entry, i) => {
            const li = document.createElement("li");
            li.className = "list-group-item d-flex justify-content-between align-items-center";
            const ipDisplay = entry.type === 'single' ? entry.ip : `${entry.start_ip} - ${entry.end_ip}`;
            const portsDisplay = formatPortsDisplay(entry.ports);
            const protocolsDisplay = formatProtocolsDisplay(entry.protocols);

            li.innerHTML = `
                    <span>${ipDisplay}${portsDisplay}${protocolsDisplay} <small class="text-muted">(${entry.reason})</small></span>
                    <button class="btn btn-sm btn-outline-danger" onclick="removeEntry(${i})">&times;</button>
                `;
            list.appendChild(li);
        });
    }

    function removeEntry(index) {
        pendingEntries.splice(index, 1);
        updatePendingList();
    }

    function submitPendingList() {
        if (pendingEntries.length === 0) {
            showAlert("No IPs in the pending list.");
            return;
        }
        document.getElementById('entriesData').value = JSON.stringify(pendingEntries);
        // In a real application, this would submit the form
        console.log('Submitting:', pendingEntries);
    }

    function showAlert(message) {
        const alertBox = document.getElementById('alertBox');
        const alertMessage = document.getElementById('alertMessage');
        alertMessage.textContent = message;
        alertBox.classList.remove('d-none');
        alertBox.classList.add('show');
    }

    function hideAlert() {
        const alertBox = document.getElementById('alertBox');
        alertBox.classList.add('d-none');
        alertBox.classList.remove('show');
    }

    function markInvalid(elementId) {
        const element = document.getElementById(elementId);
        element.classList.add('is-invalid');
    }

    function clearValidation() {
        const inputs = document.querySelectorAll('.is-invalid');
        inputs.forEach(input => input.classList.remove('is-invalid'));
    }
</script>

<!-- Add Domain Blacklist Modal -->
<div class="modal fade" id="addDomainModal" tabindex="-1">
    <div class="modal-dialog modal-lg" style="margin-top: 6.5rem;">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-globe"></i> Add Domain to Blacklist</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>

            <div class="modal-body">

                <!-- Form -->
                <form id="domainBlacklistForm" onsubmit="return false;">
                    <div class="mb-3">
                        <label for="domain" class="form-label">Domain Name *</label>
                        <input type="text" class="form-control" id="domain" name="domain" required
                            placeholder="e.g., example.com or subdomain.example.com"
                            pattern="^[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]{0,61}[a-zA-Z0-9])?)*$">
                        <!-- <input type="text" class="form-control" id="domain" placeholder="e.g., example.com"> -->
                        <div class="form-text">
                            Enter a valid domain. Blocking "example.com" also blocks "sub.example.com", etc.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="domainReasonSelect" class="form-label">Reason</label>
                        <select class="form-select" id="domainReasonSelect"
                            onchange="toggleCustomReason('domainReasonSelect', 'domainCustomReason')">
                            <option value="Malicious domain">Malicious domain</option>
                            <option value="Phishing site">Phishing site</option>
                            <option value="Spam source">Spam source</option>
                            <option value="Malware distribution">Malware distribution</option>
                            <option value="Unwanted content">Unwanted content</option>
                            <option value="Policy violation">Policy violation</option>
                            <option value="custom">Custom reason...</option>
                        </select>
                        <input type="text" class="form-control mt-2" id="domainCustomReason" style="display: none;"
                            placeholder="Enter custom reason">
                    </div>

                    <div class="mb-3 text-end">
                        <button type="button" class="btn btn-success" onclick="addDomainToList()">
                            <i class="fas fa-plus"></i> Add to List
                        </button>
                    </div>
                </form>
                <!-- Alert -->
                <div id="domainAlertBox" class="alert alert-danger alert-dismissible fade d-none" role="alert">
                    <span id="domainAlertMessage"></span>
                    <button type="button" class="btn-close" onclick="hideDomainAlert()"></button>
                </div>
                <!-- Pending List -->
                <div>
                    <h6>Pending Domains:</h6>
                    <ul class="list-group" id="pendingDomainList"></ul>
                </div>

                <div class="alert alert-warning mt-3">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> These domains will be immediately blocked along with all their subdomains.
                </div>
            </div>

            <div class="modal-footer">
                <form method="POST" action="/submit_domain_blacklist" id="submitDomainForm">
                    <input type="hidden" name="domains" id="domainEntriesData">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-warning" onclick="submitDomainList()">
                        <i class="fas fa-paper-plane"></i> Save Blacklist
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}